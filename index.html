<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pacer Assignment Optimizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/javascript-lp-solver/prod/solver.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#4f46e5',
                        'secondary': '#f97316',
                        'background': '#f3f4f6',
                        'card': '#ffffff',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        .pace-checkbox:checked + label {
            background-color: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }
        .success { color: #10b981; }
        .error { color: #ef4444; }
        .tab-inactive {
            background-color: #e5e7eb;
            color: #4b5563;
        }
        .validation-border {
            border: 2px solid #ef4444 !important;
        }

        /* --- Custom Responsive Table Styles --- */
        
        /* Global fix for pace preference height (applies to all views) */
        .pace-container {
            /* Max height equivalent to roughly 3 lines of text-xs badges (~4.5rem/72px) */
            max-height: 4.5rem; 
            overflow-y: auto;
            padding-right: 0.5rem; /* Space for scrollbar */
            /* Ensure the content is not wrapped and stays on the left */
            align-items: flex-start; 
            align-content: flex-start;
        }

        /* Mobile (Default: below sm breakpoint) Card View Transformation */
        @media (max-width: 640px) {
            #runners-table {
                /* Ensure table takes full width but allows styling on rows */
                display: block; 
            }
            #runners-table thead {
                /* Hide the table headers on mobile */
                display: none;
            }

            #runners-table tr {
                /* Make each row look like a block/card */
                display: grid;
                grid-template-columns: 1fr;
                gap: 0.5rem;
                padding: 1rem;
                margin-bottom: 1rem;
                border: 1px solid #e5e7eb;
                border-radius: 0.75rem;
                background-color: white;
                position: relative; /* For absolute positioning of delete button */
                box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            }
            
            #runners-table td {
                display: flex;
                align-items: center;
                padding: 0; /* Remove default padding */
                border: none;
                width: 100%; /* Ensure all cells take full card width */
            }

            /* Add labels to cells (tds) on mobile for clarity and order */
            #runners-table td:nth-child(1) { order: -2; justify-content: flex-start; padding-bottom: 0.5rem; border-bottom: 1px solid #f3f4f6; } 
            #runners-table td:nth-child(1) .text-sm::before { content: 'Runner #'; font-weight: 600; margin-right: 0.5rem; color: #4f46e5; }
            
            #runners-table td:nth-child(2) { order: 1; flex-direction: column; align-items: flex-start; }
            #runners-table td:nth-child(2)::before { content: 'Runner Name'; font-weight: 600; margin-bottom: 0.25rem; color: #4f46e5; }
            
            #runners-table td:nth-child(3) { order: 2; }
            #runners-table td:nth-child(3) input { text-align: left; }
            #runners-table td:nth-child(3)::before { content: 'Seniority (1 = Most)'; font-weight: 600; margin-right: 0.5rem; color: #4f46e5; }
            
            #runners-table td:nth-child(4) { order: 3; flex-direction: column; align-items: flex-start; }
            #runners-table td:nth-child(4)::before { content: 'Pace Preferences (min/mile)'; font-weight: 600; margin-bottom: 0.25rem; color: #4f46e5; }
            
            #runners-table td:nth-child(5) { order: 4; justify-content: space-between; padding-top: 0.5rem; border-top: 1px solid #f3f4f6; }
            #runners-table td:nth-child(5) .sr-only { display: block; } /* Show Active label for mobile card */
            
            #runners-table td:nth-child(6) { 
                order: -1; 
                justify-content: flex-end; 
                position: absolute; 
                top: 0.5rem; 
                right: 0.5rem; 
                width: auto;
            } /* Delete button */

            /* Full width for inputs inside the card to maximize space */
            .runner-name, .runner-seniority {
                width: 100%;
            }

            /* Hide the sr-only element on desktop */
            #runners-table td:nth-child(5) label .sr-only {
                display: none;
            }
        }
        
        /* Desktop/Tablet (sm: and up) column widths (ensure good proportions) */
        @media (min-width: 641px) {
            .runner-name-col { width: 25%; } /* More space for name */
            .seniority-col { width: 10%; } /* Reduced space for seniority */
            .pace-prefs-col { width: 45%; } /* Max space for paces */
            .active-col { width: 5%; }
            .action-col { width: 10%; }

            /* Ensure table cells have correct alignment on desktop */
            #runners-table td:nth-child(2) { text-align: left; }
            #runners-table td:nth-child(3) { text-align: center; }
            #runners-table td:nth-child(4) { text-align: left; }
        }
    </style>
</head>
<body class="bg-background min-h-screen p-4 sm:p-8 font-sans">

    <div class="max-w-6xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900 mb-2">Pacer Assignment Optimizer</h1>
            <p class="text-gray-600">Enter runner details, then run the optimizer to find the best assignments.</p>
        </header>

        <div class="bg-card shadow-xl rounded-xl p-6 sm:p-8 mb-8">
            <h2 class="text-2xl font-semibold text-primary mb-6 border-b pb-3">Runner Configuration</h2>
            
            <div class="flex space-x-2 mb-6">
                <button id="view-runner-tab" onclick="switchView('runner')"
                        class="px-4 py-2 text-sm font-medium rounded-t-lg transition duration-150 ease-in-out bg-primary text-white">
                    View by Runner
                </button>
                <button id="view-pace-tab" onclick="switchView('pace')"
                        class="px-4 py-2 text-sm font-medium rounded-t-lg transition duration-150 ease-in-out tab-inactive">
                    View by Pace
                </button>
            </div>

            <div id="runner-view-container">
                <p class="text-sm text-gray-600 mb-4">Runners are validated in real-time. Active runners missing a name, having a duplicate name, or missing a pace will be highlighted in red.</p>
                <div class="overflow-x-auto sm:overflow-x-visible">
                    <table id="runners-table" class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-[5%]">#</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider runner-name-col">Runner Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider seniority-col">Seniority (1 = Most)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider pace-prefs-col">Pace Preferences (min/mile)</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider active-col">Active</th>
                                <th class="px-3 py-3 action-col"></th>
                            </tr>
                        </thead>
                        <tbody id="runners-list" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="pace-view-container" class="hidden">
                <p class="text-sm text-gray-600 mb-4">Click "Add New Runner" to quickly assign a pace. Click the **'x'** on a runner to remove that pace preference. If a runner loses all preferences, they will be deleted.</p>
                <div id="paces-list" class="space-y-4">
                </div>
            </div>

            <div class="mt-6 flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4">
                <button onclick="addRunner(true)" class="w-full sm:w-auto px-6 py-2 border border-transparent text-sm font-medium rounded-lg shadow-sm text-white bg-secondary hover:bg-orange-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-secondary transition duration-150 ease-in-out">
                    Add Runner
                </button>
                <button onclick="exportRunners()" class="w-full sm:w-auto px-6 py-2 border border-primary text-sm font-medium rounded-lg shadow-sm text-primary bg-white hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition duration-150 ease-in-out">
                    Export Runners (Copy to Clipboard)
                </button>
                <button onclick="importRunners()" class="w-full sm:w-auto px-6 py-2 border border-primary text-sm font-medium rounded-lg shadow-sm text-white bg-primary hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition duration-150 ease-in-out">
                    Import Runners
                </button>
                <button onclick="clearAllRunners()" class="w-full sm:w-auto px-6 py-2 border border-red-500 text-sm font-medium rounded-lg shadow-sm text-red-500 bg-white hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150 ease-in-out">
                    Clear All Runners
                </button>
            </div>
        </div>

        <div class="bg-card shadow-xl rounded-xl p-6 sm:p-8">
            <h2 class="text-2xl font-semibold text-primary mb-4 border-b pb-3">Optimal Assignment Results</h2>
            <p id="status" class="font-bold text-lg mb-4 text-gray-800"></p>
            
            <div id="results-display" class="space-y-4">
            </div>

            <button onclick="runSolver()" id="solve-button" class="mt-6 w-full sm:w-auto px-6 py-3 border border-transparent text-base font-medium rounded-lg shadow-sm text-white bg-primary hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition duration-150 ease-in-out">
                Run Solver
            </button>

                <button onclick="exportAssignments()" class="w-full sm:w-auto px-6 py-2 border border-primary text-sm font-medium rounded-lg shadow-sm text-primary bg-white hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition duration-150 ease-in-out">
                    Export Assignments (Copy to Clipboard)
                </button>
        </div>
    </div>

    <script>
        const PACES=["7:00 min/mile","7:30 min/mile","8:00 min/mile","8:30 min/mile","9:00 min/mile","9:30 min/mile","10:00 min/mile","10:30 min/mile","11:00 min/mile"];let R={},result_string="",rCount=0,currentView="runner",inputChanged=!1,hasEverSolved=!1,editingState={pace:null,runnerId:null};const sEl=document.getElementById("status"),resEl=document.getElementById("results-display"),solBtn=document.getElementById("solve-button");function genId(){return"undefined"!=typeof crypto&&crypto.randomUUID?crypto.randomUUID():`r${++rCount}`}function setBtnState(e){solBtn.disabled=!e,e?solBtn.classList.remove("opacity-50","cursor-not-allowed"):solBtn.classList.add("opacity-50","cursor-not-allowed")}function markChanged(){inputChanged&&(hasEverSolved||"Status: Ready to configure runners and solve."===sEl.textContent)||(inputChanged=!0,setBtnState(!0),hasEverSolved?(sEl.textContent="Status: Input changed. Run solver again.",sEl.className="font-bold text-lg mb-4 text-secondary"):(sEl.textContent="Status: Ready to configure runners and solve.",sEl.className="font-bold text-lg mb-4 text-gray-800"))}function findDups(){let e=Object.values(R).filter(e=>e.active&&e.name.trim()),t={};e.forEach(e=>{let n=e.name.trim().toLowerCase();t[n]=t[n]||[],t[n].push(e.id)});let n=new Set;for(let r in t)t[r].length>1&&t[r].forEach(e=>n.add(e));return n}function createNewRunnerInData(e="",t=null,n=[],r=!0){let a=genId();return R[a]={id:a,name:e,seniority:null!==t?t:Object.keys(R).length+1,paces:n,active:r},markChanged(),a}function addRunner(e=!0){let t=createNewRunnerInData();if(e){if("runner"===currentView){renderRView();let n=document.getElementById(`runner-row-${t}`);n&&n.scrollIntoView({behavior:"smooth",block:"center"})}else renderPView()}}function updateRunnerData(e,t,n){R[e]&&!("seniority"===t&&isNaN(n))&&(R[e][t]=n,markChanged())}function deleteRunner(e){R[e]&&(delete R[e],"runner"===currentView?renderRView():(editingState.runnerId===e&&(editingState={pace:null,runnerId:null}),renderPView()),markChanged())}function clearAllRunners(e=!1){R={},editingState={pace:null,runnerId:null},rCount=0,inputChanged=!0,hasEverSolved=!1,resEl.innerHTML="",e||addRunner(!1),"runner"===currentView?renderRView():renderPView(),sEl.textContent="Status: All runners cleared. A new row has been added.",sEl.className="font-bold text-lg mb-4 text-gray-800",setBtnState(!0)}function removePaceFromRunner(e,t){if(!R[e])return;let n=R[e],r=n.paces.length;if(n.paces=n.paces.filter(e=>e!==t),0===n.paces.length){let a=n.name||"Untitled Runner";delete R[e],sEl.textContent=`Status: Runner '${a}' deleted because they had no remaining pace preferences.`,sEl.className="success font-bold text-lg mb-4"}else{if(!(n.paces.length<r))return;sEl.textContent=`Status: Removed ${t} preference from ${n.name||"Untitled Runner"}.`,sEl.className="font-bold text-lg mb-4 text-gray-800"}markChanged(),renderPView(),setTimeout(()=>markChanged(),3e3)}function startAddingRunner(e){editingState.runnerId&&delete R[editingState.runnerId];let t=createNewRunnerInData("",null,[e],!0);editingState={pace:e,runnerId:t},renderPView();let n=document.getElementById(`new-runner-input-${t}`);n&&setTimeout(()=>n.focus(),0)}function finalizeNewRunnerName(e,t,n){if(editingState.runnerId!==t)return;if(!(n=n.trim())){delete R[t],editingState={pace:null,runnerId:null},renderPView(),sEl.textContent="Error: Runner creation cancelled. Name cannot be blank.",sEl.className="error font-bold text-lg mb-4",setTimeout(()=>markChanged(),2e3);return}let r=n.toLowerCase(),a=null;for(let s in R)if(s!==t&&R[s].name.toLowerCase()===r){a=s;break}if(a){let l=R[a];l.paces.includes(e)?(sEl.textContent=`Status: Runner '${l.name}' already prefers ${e}.`,sEl.className="font-bold text-lg mb-4 text-gray-800"):(l.paces.push(e),sEl.textContent=`Status: Pace preference added to existing runner '${l.name}'!`,sEl.className="success font-bold text-lg mb-4"),delete R[t]}else R[t].name=n,null===R[t].seniority&&(R[t].seniority=Object.keys(R).length),sEl.textContent=`Status: New runner '${n}' created and assigned to ${e}.`,sEl.className="success font-bold text-lg mb-4";editingState={pace:null,runnerId:null},renderPView(),markChanged(),setTimeout(()=>markChanged(),3e3)}function handleNewRunnerNameInput(e,t,n){if("Enter"!==e.key)return;e.preventDefault();let r=e.target.value;finalizeNewRunnerName(t,n,r)}function handleNewRunnerNameBlur(e,t){if(editingState.runnerId!==t)return;let n=document.getElementById(`new-runner-input-${t}`);if(!n)return;let r=n.value;finalizeNewRunnerName(e,t,r)}function renderPView(){let e=document.getElementById("paces-list");e.innerHTML="";let t=Object.values(R);if(PACES.forEach(n=>{let r=t.filter(e=>e.paces.includes(n)&&e.id!==editingState.runnerId),a=r.sort((e,t)=>e.seniority-t.seniority),s=a.map(e=>e.active?`<span class="inline-flex items-center bg-primary/20 text-primary px-2 py-0.5 text-xs font-medium rounded-full m-0.5 whitespace-nowrap">
                        <span>${e.name||"Untitled Runner"} (${e.seniority})</span>
                        <button onclick="removePaceFromRunner('${e.id}', '${n}')" title="Remove ${n} preference from ${e.name}" class="ml-1 text-primary/70 hover:text-red-600 transition duration-150 p-0.5 rounded-full hover:bg-white/50 leading-none focus:outline-none focus:ring-2 focus:ring-primary/50">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                        </button>
                    </span>`:"").join(""),l=editingState.pace===n,i=l?R[editingState.runnerId]:null;e.innerHTML+=`
                    <div class="p-4 bg-white shadow rounded-lg border-l-4 border-secondary flex flex-col justify-between items-start">
                        <div class="w-full flex justify-between items-start sm:items-center flex-col sm:flex-row mb-3">
                            <p class="font-bold text-lg mb-2 sm:mb-0">${n} <span class="text-gray-500 font-normal text-sm">(${r.filter(e=>e.active).length} active runners)</span></p>
                            ${l?"":`
                                <button onclick="startAddingRunner('${n}')" class="px-4 py-2 border border-transparent text-xs font-medium rounded-lg shadow-sm text-white bg-secondary hover:bg-orange-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-secondary transition duration-150 ease-in-out whitespace-nowrap">
                                    Add New Runner to this Pace
                                </button>`}
                        </div>
                        <div class="flex flex-wrap min-h-[2rem] w-full">
                            ${s.length>0?s:'<span class="text-gray-400 text-sm">No runners currently prefer this pace.</span>'}
                            ${l&&i?`
                                <input type="text" id="new-runner-input-${i.id}" placeholder="Enter runner name and press Enter or blur"
                                    onkeydown="handleNewRunnerNameInput(event, '${n}', '${i.id}')"
                                    onblur="handleNewRunnerNameBlur('${n}', '${i.id}')"
                                    class="w-full sm:w-80 p-2 border border-primary rounded-lg text-sm focus:ring-primary focus:border-primary shadow-md">
                            `:""}
                        </div>
                    </div>
                `}),editingState.runnerId){let n=document.getElementById(`new-runner-input-${editingState.runnerId}`);n&&setTimeout(()=>n.focus(),0)}}function switchView(e){"runner"===currentView?syncData():"pace"===currentView&&editingState.runnerId&&(delete R[editingState.runnerId],editingState={pace:null,runnerId:null}),currentView=e;let t=document.getElementById("runner-view-container"),n=document.getElementById("pace-view-container"),r=document.getElementById("view-runner-tab"),a=document.getElementById("view-pace-tab");"runner"===e?(t.classList.remove("hidden"),n.classList.add("hidden"),renderRView(),r.classList.remove("tab-inactive"),r.classList.add("bg-primary","text-white"),a.classList.remove("bg-primary","text-white"),a.classList.add("tab-inactive")):"pace"===e&&(t.classList.add("hidden"),n.classList.remove("hidden"),renderPView(),a.classList.remove("tab-inactive"),a.classList.add("bg-primary","text-white"),r.classList.remove("bg-primary","text-white"),r.classList.add("tab-inactive"))}function getRunnerElements(e){let t=document.getElementById(`runner-row-${e}`);return t?{nameInput:t.querySelector(".runner-name"),paceContainer:t.querySelector(".pace-container")}:null}function validateRow(e,t){let n=R[e],r=getRunnerElements(e);if(!r||!n)return;let{nameInput:a,paceContainer:s}=r;if(a.classList.remove("validation-border"),s.classList.remove("validation-border"),n.active){if(t.has(e)||!n.name.trim()){a.classList.add("validation-border");return}0===n.paces.length&&s.classList.add("validation-border")}}function generatePaceCheckboxes(e,t){return PACES.map(n=>`
                <input type="checkbox" id="pace-${e}-${n.replace(/[:\/ ]/g,"-")}" data-pace="${n}"
                    class="pace-checkbox hidden" value="${n}" data-runner-id="${e}"
                    ${t.includes(n)?"checked":""}>
                <label for="pace-${e}-${n.replace(/[:\/ ]/g,"-")}"
                    class="inline-block px-2 py-1 text-xs font-medium text-gray-700 bg-gray-100 border border-gray-300 rounded-full cursor-pointer
                    hover:bg-gray-200 transition duration-150 ease-in-out m-0.5 whitespace-nowrap">
                    ${n.split(" ")[0]}
                </label>
            `).join("")}function renderRRow(e,t){let n=document.createElement("tr");return n.id=`runner-row-${e.id}`,n.className="runner-row hover:bg-gray-50 transition duration-150 relative",n.innerHTML=`
                <td class="px-3 py-3 whitespace-nowrap">
                    <span class="text-sm text-gray-500">${t+1}</span>
                </td>
                <td class="px-6 py-3">
                    <input type="text" placeholder="e.g., Jane Doe" required value="${e.name}" data-runner-id="${e.id}"
                        class="runner-name w-full p-2 border border-gray-300 rounded-lg text-sm focus:ring-primary focus:border-primary">
                </td>
                <td class="px-6 py-3 whitespace-nowrap">
                    <input type="number" value="${e.seniority}" min="1" required data-runner-id="${e.id}"
                        class="runner-seniority w-full sm:w-20 p-2 border border-gray-300 rounded-lg text-sm text-center focus:ring-primary focus:border-primary">
                </td>
                <td class="px-6 py-3">
                    <div id="pace-container-${e.id}" class="pace-container flex flex-wrap space-x-1 p-1 border border-transparent rounded-lg transition duration-150 ease-in-out">
                        ${generatePaceCheckboxes(e.id,e.paces)}
                    </div>
                </td>
                <td class="px-3 py-3 whitespace-nowrap">
                    <div class="flex justify-center sm:justify-start items-center h-full">
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" ${e.active?"checked":""} class="sr-only peer runner-active-toggle" data-runner-id="${e.id}">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary/40 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                            <span class="ml-3 text-sm font-medium text-gray-900 sr-only">Active Toggle</span>
                        </label>
                    </div>
                </td>
                <td class="px-3 py-3 whitespace-nowrap">
                    <button onclick="deleteRunner('${e.id}')" class="p-2 text-red-500 hover:text-red-700 rounded-full transition duration-150">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </td>
            `,n}function renderRView(){let e=document.getElementById("runners-list");e.innerHTML="";let t=Object.values(R).sort((e,t)=>e.seniority-t.seniority),n=findDups();t.forEach((t,r)=>{let a=renderRRow(t,r);e.appendChild(a),validateRow(t.id,n)}),setupRListeners()}function setupRListeners(){let e=document.getElementById("runners-list");e.removeEventListener("change",handleRInput),e.removeEventListener("input",handleRInput),e.addEventListener("change",handleRInput),e.addEventListener("input",handleRInput)}function handleRInput(e){let t=e.target,n=t.dataset.runnerId;if(!R[n])return;if(t.classList.contains("runner-name"))updateRunnerData(n,"name",t.value.trim());else if(t.classList.contains("runner-seniority"))updateRunnerData(n,"seniority",parseInt(t.value));else if(t.classList.contains("runner-active-toggle"))updateRunnerData(n,"active",t.checked);else if(t.classList.contains("pace-checkbox")){let r=R[n],a=r.paces,s=t.getAttribute("data-pace");if(t.checked)a.includes(s)||a.push(s);else{let l=a.indexOf(s);l>-1&&a.splice(l,1)}r.paces=a}let i=findDups();t.classList.contains("runner-name")||t.classList.contains("runner-active-toggle")?Object.keys(R).forEach(e=>{validateRow(e,i)}):validateRow(n,i),markChanged()}function syncData(){if("pace"===currentView)return;let e=document.querySelectorAll(".runner-row"),t=findDups();e.forEach(e=>{let n=e.id.replace("runner-row-","");if(!R[n])return;let r=e.querySelector(".runner-name"),a=e.querySelector(".runner-seniority"),s=e.querySelector(".runner-active-toggle"),l=e.querySelectorAll(".pace-checkbox"),i=Array.from(l).filter(e=>e.checked).map(e=>e.getAttribute("data-pace"));R[n].name=r.value.trim(),R[n].seniority=parseInt(a.value)||1,R[n].paces=i,R[n].active=s.checked,validateRow(n,t)})}function exportRunners(){syncData();let e=Object.values(R).filter(e=>e.name).map(e=>({name:e.name,seniority:e.seniority,paces:e.paces,active:e.active})),t=JSON.stringify(e,null,2);navigator.clipboard?navigator.clipboard.writeText(t).then(()=>{sEl.textContent="Status: Runner data copied to clipboard as JSON!",sEl.className="success font-bold text-lg mb-4"}).catch(e=>{console.error("Failed to copy text: ",e),prompt("Copy the following JSON data manually:",t),sEl.textContent="Status: Clipboard copy failed. Data ready in prompt box for manual copy.",sEl.className="font-bold text-lg mb-4 text-secondary"}):(prompt("Copy the following JSON data manually:",t),sEl.textContent="Status: Runner data ready in prompt box for manual copy.",sEl.className="font-bold text-lg mb-4 text-secondary")}function exportAssignments(){syncData();let e=result_string;navigator.clipboard?navigator.clipboard.writeText(e).then(()=>{sEl.textContent="Status: Runner assignments copied to clipboard!",sEl.className="success font-bold text-lg mb-4"}).catch(t=>{console.error("Failed to copy text: ",t),prompt("Copy the following JSON data manually:",e),sEl.textContent="Status: Clipboard copy failed. Data ready in prompt box for manual copy.",sEl.className="font-bold text-lg mb-4 text-secondary"}):(prompt("Copy the following JSON data manually:",e),sEl.textContent="Status: Runner assignments ready in prompt box for manual copy.",sEl.className="font-bold text-lg mb-4 text-secondary")}function importRunners(){let e=prompt("Paste the JSON string containing runner data here:");if(!e){sEl.textContent="Status: Import cancelled.",sEl.className="font-bold text-lg mb-4 text-gray-800";return}try{let t=JSON.parse(e);if(!Array.isArray(t)||t.some(e=>"object"!=typeof e||void 0===e.name||void 0===e.seniority))throw Error("Invalid JSON structure. Expected an array of runner objects with 'name' and 'seniority' fields.");clearAllRunners(!0),t.forEach(e=>{createNewRunnerInData(e.name,e.seniority,e.paces||[],void 0===e.active||e.active)}),"runner"===currentView?renderRView():renderPView(),markChanged(),window.scrollTo({top:0,behavior:"smooth"}),sEl.textContent=`Status: Successfully imported ${t.length} runners. Run the solver to get assignments.`,sEl.className="success font-bold text-lg mb-4"}catch(n){console.error("Import Error:",n),sEl.textContent=`Error: Failed to import data. ${n.message||"Invalid JSON format."}`,sEl.className="error font-bold text-lg mb-4"}}function generatePaceGroups(){let e={};for(let t=14;t<=22;t++){let n=t/2,r=Math.floor(n),a=Math.round((n-r)*60),s=`${r}:${a.toString().padStart(2,"0")} min/mile`;e[s]=n}return e}function solveAssignmentProblem(e){let t=generatePaceGroups(),n=Object.keys(t),r={...t},a=Math.max(...Object.values(r)),s=Object.keys(e);if(0===s.length)return{error:"No active runners provided for assignment."};let l={},i={};s.forEach(t=>{l[t]=e[t].paces,i[t]=e[t].seniority});let o=s.sort((e,t)=>{let n=i[e]-i[t];return 0!==n?n:e.localeCompare(t)}),d=Math.max(...Object.values(i)),u=Object.fromEntries(o.map(e=>[e,d+1-i[e]])),c=Object.fromEntries(n.map(e=>[e,a-r[e]])),m={};for(let p of o)for(let f of n){let g=l[p].includes(f);m[`${p}|${f}`]=g?u[p]*c[f]*1e-6:0}let $={};for(let b of o)for(let h of n)$[`${b}|${h}`]=l[b].includes(h)?1:0;let y={optimize:"range",opType:"min",constraints:{},variables:{},ints:{}};y.variables.Z_max={range:1},y.variables.Z_min={range:-1},n.forEach(e=>{let t=`N_${e}`;y.variables[t]={[`count_link_${e}`]:1,[`max_bound_${e}`]:-1,[`min_bound_${e}`]:-1},y.ints[t]=1,y.constraints[`count_link_${e}`]={equal:0},y.constraints[`max_bound_${e}`]={min:0},y.variables.Z_max[`max_bound_${e}`]=1,y.constraints[`min_bound_${e}`]={max:0},y.variables.Z_min[`min_bound_${e}`]=1}),o.forEach(e=>{let t=`runner_assign_${e}`;y.constraints[t]={equal:1},n.forEach(n=>{let r=`assign_${e}_${n}`;y.variables[r]={[t]:1,[`count_link_${n}`]:-1},y.ints[r]=1;let a=`ability_${e}_${n}`;y.constraints[a]={min:0,max:$[`${e}|${n}`]},y.variables[r][a]=1})});let x=solver.Solve(y);if(!x.feasible)return{error:"No feasible solution found. Cannot assign all runners based on preferences."};let v=x.result,w={optimize:"totalCost",opType:"min",constraints:{},variables:{},ints:{}};w.variables.Z_max_2={fixed_range:1},w.variables.Z_min_2={fixed_range:-1},n.forEach(e=>{let t=`N2_${e}`;w.variables[t]={[`count_link_2_${e}`]:1,[`max_bound_2_${e}`]:-1,[`min_bound_2_${e}`]:-1},w.ints[t]=1,w.constraints[`count_link_2_${e}`]={equal:0},w.constraints[`max_bound_2_${e}`]={min:0},w.variables.Z_max_2[`max_bound_2_${e}`]=1,w.constraints[`min_bound_2_${e}`]={max:0},w.variables.Z_min_2[`min_bound_2_${e}`]=1}),o.forEach(e=>{let t=`runner_assign_2_${e}`;w.constraints[t]={equal:1},n.forEach(n=>{let a=`assign_${e}_${n}`,s=r[n]-m[`${e}|${n}`];w.variables[a]={totalCost:s,[t]:1,[`count_link_2_${n}`]:-1},w.ints[a]=1;let l=`ability_2_${e}_${n}`;w.constraints[l]={min:0,max:$[`${e}|${n}`]},w.variables[a][l]=1})}),w.constraints.fixed_range={equal:v};let E=solver.Solve(w);if(!E.feasible)return{error:"Failed to find a pace-optimal solution that maintains the minimum group balance. Try reducing constraints."};let _={assignments:{},groups:{}};for(let S in n.forEach(e=>_.groups[e]=[]),e){for(let C of n)1===E[`assign_${S}_${C}`]&&(_.assignments[S]=C,_.groups[C].push(S));delete e[S].paces}return _.meta={minRange:v,totalCost:E.result},_}function runSolver(){if(syncData(),!inputChanged&&hasEverSolved){sEl.textContent="Status: Input has not changed since last successful solve.",sEl.className="font-bold text-lg mb-4 text-gray-800";return}resEl.innerHTML="",sEl.textContent="Status: Validating runner data...",sEl.className="font-bold text-lg mb-4 text-gray-800";let e={},t=!1,n=!1,r=findDups(),a=r.size>0;if(Object.values(R).forEach(a=>{if(validateRow(a.id,r),!a.active)return;let s=a.name;s.trim()||(t=!0),s.trim()&&0===a.paces.length&&(n=!0),s.trim()&&a.paces.length>0&&!r.has(a.id)&&(e[a.id]=a)}),t||a||n){let s=[];t&&s.push("One or more active runners are missing a **Name**."),a&&s.push("One or more active runners have **Duplicate Names**."),n&&s.push("One or more active runners have **No Pace Preferences** selected."),sEl.textContent=`Error: Data validation failed. ${s.join(" ")}`,sEl.className="error font-bold text-lg mb-4","pace"===currentView&&switchView("runner"),setBtnState(!0);return}if(0===Object.keys(e).length){sEl.textContent="Status: No active or valid runner data provided.",sEl.className="font-bold text-lg mb-4 text-gray-800",setBtnState(!1);return}let l=solveAssignmentProblem(e);l.error?(sEl.textContent=`Error: ${l.error}`,sEl.className="error font-bold text-lg mb-4",resEl.innerHTML='<p class="text-red-600 p-3 bg-red-50 rounded-lg">Optimization failed. Check if all active runners have at least one pace preference selected and if the preferences allow for a balanced solution.</p>',setBtnState(!0)):(sEl.textContent="Status: Done!",sEl.className="success font-bold text-lg mb-4",displayResults(l,e),inputChanged=!1,hasEverSolved=!0,setBtnState(!1))}function displayResults(e,t){result_string="",resEl.innerHTML=`
                <h3 class="font-semibold text-lg text-gray-800 pb-2">Assignments by Pace Group</h3>
                <div id="groups-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            `;let n=document.getElementById("groups-list"),r=Object.keys(e.groups).sort((e,t)=>{let n=e=>{let[t,n]=e.split(" ")[0].split(":").map(Number);return t+n/60};return n(e)-n(t)});r.forEach(r=>{let a=e.groups[r];if(out_string=r.split(" ")[0]+": ",first_runner=!0,a.length>0){let s=a.sort((e,n)=>t[e].seniority-t[n].seniority),l=s.map(e=>{let n=t[e];return first_runner?out_string+=n.name:out_string+=", "+n.name,`<span class="inline-block bg-primary/20 text-primary px-2 py-0.5 text-xs font-medium rounded-full m-0.5">${n.name} (${n.seniority})</span>`}).join("");n.innerHTML+=`
                        <div class="p-4 bg-white shadow rounded-lg border-l-4 border-primary">
                            <p class="font-bold text-md mb-2">${r} <span class="text-gray-500 font-normal">(${a.length} runners)</span></p>
                            <div class="flex flex-wrap">${l}</div>
                        </div>
                    `}result_string+=out_string+"\n"})}window.onload=()=>{createNewRunnerInData("",1,[],!0),switchView("runner"),sEl.textContent="Status: Ready to configure runners and solve.",sEl.className="font-bold text-lg mb-4 text-gray-800"};    </script>
</body>
</html>
