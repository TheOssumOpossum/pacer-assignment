<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pacer Assignment Optimizer</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load the JavaScript LP Solver Library -->
    <script src="https://unpkg.com/javascript-lp-solver/prod/solver.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#4f46e5',
                        'secondary': '#f97316',
                        'background': '#f3f4f6',
                        'card': '#ffffff',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* Custom styling for pace preference selection */
        .pace-checkbox:checked + label {
            background-color: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }
        .success { color: #10b981; } /* Tailwind green-500 */
        .error { color: #ef4444; } /* Tailwind red-500 */
        /* Custom styling for the tab background */
        .tab-inactive {
            background-color: #e5e7eb; /* gray-200 */
            color: #4b5563; /* gray-700 */
        }
        /* Custom utility to simplify applying validation in JS */
        .validation-border {
            border: 2px solid #ef4444 !important; /* Forces red-500 border-2 */
        }
    </style>
</head>
<body class="bg-background min-h-screen p-4 sm:p-8 font-sans">

    <div class="max-w-6xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900 mb-2">Pacer Assignment Optimizer</h1>
            <p class="text-gray-600">Enter runner details, then run the optimizer to find the best assignments.</p>
        </header>

        <!-- Main Card for Runner Input -->
        <div class="bg-card shadow-xl rounded-xl p-6 sm:p-8 mb-8">
            <h2 class="text-2xl font-semibold text-primary mb-6 border-b pb-3">Runner Configuration</h2>
            
            <!-- View Toggle Tabs -->
            <div class="flex space-x-2 mb-6">
                <button id="view-runner-tab" onclick="switchView('runner')"
                        class="px-4 py-2 text-sm font-medium rounded-t-lg transition duration-150 ease-in-out bg-primary text-white">
                    View by Runner
                </button>
                <button id="view-pace-tab" onclick="switchView('pace')"
                        class="px-4 py-2 text-sm font-medium rounded-t-lg transition duration-150 ease-in-out tab-inactive">
                    View by Pace
                </button>
            </div>

            <!-- Runner View Container (Table) -->
            <div id="runner-view-container">
                <p class="text-sm text-gray-600 mb-4">Runners are validated in real-time. Active runners missing a name, having a duplicate name, or missing a pace will be highlighted in red.</p>
                <!-- Runner List Table -->
                <div class="overflow-x-auto">
                    <table id="runners-table" class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-[5%]">#</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-[15%]">Runner Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-[10%]">Seniority (1 = Most)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-[55%]">Pace Preferences (min/mile)</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-[5%]">Active</th>
                                <th class="px-3 py-3 w-[10%]"></th>
                            </tr>
                        </thead>
                        <tbody id="runners-list" class="bg-white divide-y divide-gray-200">
                            <!-- Runner rows will be appended here by renderRunnerView() -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Pace View Container (Cards/Rows) -->
            <div id="pace-view-container" class="hidden">
                <p class="text-sm text-gray-600 mb-4">Click "Add New Runner" to quickly assign a pace. Click the **'x'** on a runner to remove that pace preference. If a runner loses all preferences, they will be deleted.</p>
                <div id="paces-list" class="space-y-4">
                    <!-- Pace rows will be appended here by renderPaceView() -->
                </div>
            </div>

            <div class="mt-6 flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4">
                <!-- The "Add Runner" button now calls the utility function which creates data and re-renders the current view -->
                <button onclick="addRunner(true)" class="w-full sm:w-auto px-6 py-2 border border-transparent text-sm font-medium rounded-lg shadow-sm text-white bg-secondary hover:bg-orange-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-secondary transition duration-150 ease-in-out">
                    Add Runner
                </button>
                <button onclick="exportRunners()" class="w-full sm:w-auto px-6 py-2 border border-primary text-sm font-medium rounded-lg shadow-sm text-primary bg-white hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition duration-150 ease-in-out">
                    Export Runners (Copy to Clipboard)
                </button>
                <button onclick="importRunners()" class="w-full sm:w-auto px-6 py-2 border border-primary text-sm font-medium rounded-lg shadow-sm text-white bg-primary hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition duration-150 ease-in-out">
                    Import Runners
                </button>
                <button onclick="clearAllRunners()" class="w-full sm:w-auto px-6 py-2 border border-red-500 text-sm font-medium rounded-lg shadow-sm text-red-500 bg-white hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150 ease-in-out">
                    Clear All Runners
                </button>
            </div>
        </div>

        <!-- Output/Solver Card -->
        <div class="bg-card shadow-xl rounded-xl p-6 sm:p-8">
            <h2 class="text-2xl font-semibold text-primary mb-4 border-b pb-3">Optimal Assignment Results</h2>
            <p id="status" class="font-bold text-lg mb-4 text-gray-800"></p>
            
            <div id="results-display" class="space-y-4">
                <!-- Results will be displayed here -->
            </div>

            <button onclick="runSolver()" id="solve-button" class="mt-6 w-full sm:w-auto px-6 py-3 border border-transparent text-base font-medium rounded-lg shadow-sm text-white bg-primary hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition duration-150 ease-in-out">
                Run Solver
            </button>
        </div>
    </div>

    <script>
        const PACE_GROUPS=["7:00 min/mile","7:30 min/mile","8:00 min/mile","8:30 min/mile","9:00 min/mile","9:30 min/mile","10:00 min/mile","10:30 min/mile","11:00 min/mile"];let runners={},runnerCounter=0,currentView="runner",inputChanged=!1,hasEverSolved=!1,paceViewEditing={pace:null,runnerId:null};const statusEl=document.getElementById("status"),resultsEl=document.getElementById("results-display"),solveButton=document.getElementById("solve-button");function generateRunnerId(){return"undefined"!=typeof crypto&&crypto.randomUUID?crypto.randomUUID():`r${++runnerCounter}`}function setSolverButtonState(e){solveButton.disabled=!e,e?solveButton.classList.remove("opacity-50","cursor-not-allowed"):solveButton.classList.add("opacity-50","cursor-not-allowed")}function markInputChanged(){inputChanged&&(hasEverSolved||"Status: Ready to configure runners and solve."===statusEl.textContent)||(inputChanged=!0,setSolverButtonState(!0),hasEverSolved?(statusEl.textContent="Status: Input changed. Run solver again.",statusEl.className="font-bold text-lg mb-4 text-secondary"):(statusEl.textContent="Status: Ready to configure runners and solve.",statusEl.className="font-bold text-lg mb-4 text-gray-800"))}function findDuplicateNames(){let e=Object.values(runners).filter(e=>e.active&&e.name.trim()),t={};e.forEach(e=>{let n=e.name.trim().toLowerCase();t[n]=t[n]||[],t[n].push(e.id)});let n=new Set;for(let r in t)t[r].length>1&&t[r].forEach(e=>n.add(e));return n}function createNewRunnerInData(e="",t=null,n=[],r=!0){let a=generateRunnerId();return runners[a]={id:a,name:e,seniority:null!==t?t:Object.keys(runners).length+1,paces:n,active:r},markInputChanged(),a}function addRunner(e=!0){let t=createNewRunnerInData();if(e){if("runner"===currentView){renderRunnerView();let n=document.getElementById(`runner-row-${t}`);n&&n.scrollIntoView({behavior:"smooth",block:"center"})}else renderPaceView()}}function updateRunnerData(e,t,n){runners[e]&&!("seniority"===t&&isNaN(n))&&(runners[e][t]=n,markInputChanged())}function deleteRunner(e){runners[e]&&(delete runners[e],"runner"===currentView?renderRunnerView():(paceViewEditing.runnerId===e&&(paceViewEditing={pace:null,runnerId:null}),renderPaceView()),markInputChanged())}function clearAllRunners(e=!1){runners={},paceViewEditing={pace:null,runnerId:null},runnerCounter=0,inputChanged=!0,hasEverSolved=!1,resultsEl.innerHTML="",e||addRunner(!1),"runner"===currentView?renderRunnerView():renderPaceView(),statusEl.textContent="Status: All runners cleared. A new row has been added.",statusEl.className="font-bold text-lg mb-4 text-gray-800",setSolverButtonState(!0)}function removePaceFromRunner(e,t){if(!runners[e])return;let n=runners[e],r=n.paces.length;if(n.paces=n.paces.filter(e=>e!==t),0===n.paces.length){let a=n.name||"Untitled Runner";delete runners[e],statusEl.textContent=`Status: Runner '${a}' deleted because they had no remaining pace preferences.`,statusEl.className="success font-bold text-lg mb-4"}else{if(!(n.paces.length<r))return;statusEl.textContent=`Status: Removed ${t} preference from ${n.name||"Untitled Runner"}.`,statusEl.className="font-bold text-lg mb-4 text-gray-800"}markInputChanged(),renderPaceView(),setTimeout(()=>markInputChanged(),3e3)}function startAddingRunner(e){paceViewEditing.runnerId&&delete runners[paceViewEditing.runnerId];let t=createNewRunnerInData("",null,[e],!0);paceViewEditing={pace:e,runnerId:t},renderPaceView();let n=document.getElementById(`new-runner-input-${t}`);n&&setTimeout(()=>n.focus(),0)}function finalizeNewRunnerName(e,t,n){if(paceViewEditing.runnerId!==t)return;if(!(n=n.trim())){delete runners[t],paceViewEditing={pace:null,runnerId:null},renderPaceView(),statusEl.textContent="Error: Runner creation cancelled. Name cannot be blank.",statusEl.className="error font-bold text-lg mb-4",setTimeout(()=>markInputChanged(),2e3);return}let r=n.toLowerCase(),a=null;for(let s in runners)if(s!==t&&runners[s].name.toLowerCase()===r){a=s;break}if(a){let i=runners[a];i.paces.includes(e)?(statusEl.textContent=`Status: Runner '${i.name}' already prefers ${e}.`,statusEl.className="font-bold text-lg mb-4 text-gray-800"):(i.paces.push(e),statusEl.textContent=`Status: Pace preference added to existing runner '${i.name}'!`,statusEl.className="success font-bold text-lg mb-4"),delete runners[t]}else runners[t].name=n,null===runners[t].seniority&&(runners[t].seniority=Object.keys(runners).length),statusEl.textContent=`Status: New runner '${n}' created and assigned to ${e}.`,statusEl.className="success font-bold text-lg mb-4";paceViewEditing={pace:null,runnerId:null},renderPaceView(),markInputChanged(),setTimeout(()=>markInputChanged(),3e3)}function handleNewRunnerNameInput(e,t,n){if("Enter"!==e.key)return;e.preventDefault();let r=e.target.value;finalizeNewRunnerName(t,n,r)}function handleNewRunnerNameBlur(e,t){if(paceViewEditing.runnerId!==t)return;let n=document.getElementById(`new-runner-input-${t}`);if(!n)return;let r=n.value;finalizeNewRunnerName(e,t,r)}function renderPaceView(){let e=document.getElementById("paces-list");e.innerHTML="";let t=Object.values(runners);if(PACE_GROUPS.forEach(n=>{let r=t.filter(e=>e.paces.includes(n)&&e.id!==paceViewEditing.runnerId),a=r.sort((e,t)=>e.seniority-t.seniority),s=a.map(e=>e.active?`
                            <span class="inline-flex items-center bg-primary/20 text-primary px-2 py-0.5 text-xs font-medium rounded-full m-0.5 whitespace-nowrap">
                                <span>${e.name||"Untitled Runner"} (${e.seniority})</span>
                                <button onclick="removePaceFromRunner('${e.id}', '${n}')" title="Remove ${n} preference from ${e.name}"
                                        class="ml-1 text-primary/70 hover:text-red-600 transition duration-150 p-0.5 rounded-full hover:bg-white/50 leading-none focus:outline-none focus:ring-2 focus:ring-primary/50">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </span>
                        `:"").join(""),i=paceViewEditing.pace===n,l=i?runners[paceViewEditing.runnerId]:null;e.innerHTML+=`
                    <div class="p-4 bg-white shadow rounded-lg border-l-4 border-secondary flex flex-col justify-between items-start">
                        <div class="w-full flex justify-between items-start sm:items-center flex-col sm:flex-row mb-3">
                            <p class="font-bold text-lg mb-2 sm:mb-0">${n} <span class="text-gray-500 font-normal text-sm">(${r.filter(e=>e.active).length} active runners)</span></p>
                            
                            ${i?"":`<button onclick="startAddingRunner('${n}')"
                                        class="px-4 py-2 border border-transparent text-xs font-medium rounded-lg shadow-sm text-white bg-secondary hover:bg-orange-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-secondary transition duration-150 ease-in-out whitespace-nowrap">
                                    Add New Runner to this Pace
                                </button>`}
                        </div>
                        
                        <div class="flex flex-wrap min-h-[2rem] w-full">
                            ${s.length>0?s:'<span class="text-gray-400 text-sm">No runners currently prefer this pace.</span>'}
                            
                            <!-- Input for new runner name with onblur handler -->
                            ${i&&l?`
                                <input type="text" id="new-runner-input-${l.id}" placeholder="Enter runner name and press Enter or blur" 
                                    onkeydown="handleNewRunnerNameInput(event, '${n}', '${l.id}')"
                                    onblur="handleNewRunnerNameBlur('${n}', '${l.id}')"
                                    class="w-full sm:w-80 p-2 border border-primary rounded-lg text-sm focus:ring-primary focus:border-primary shadow-md">
                            `:""}
                        </div>
                    </div>
                `}),paceViewEditing.runnerId){let n=document.getElementById(`new-runner-input-${paceViewEditing.runnerId}`);n&&setTimeout(()=>n.focus(),0)}}function switchView(e){"runner"===currentView?collectRunnerDataFromUI():"pace"===currentView&&paceViewEditing.runnerId&&(delete runners[paceViewEditing.runnerId],paceViewEditing={pace:null,runnerId:null}),currentView=e;let t=document.getElementById("runner-view-container"),n=document.getElementById("pace-view-container"),r=document.getElementById("view-runner-tab"),a=document.getElementById("view-pace-tab");"runner"===e?(t.classList.remove("hidden"),n.classList.add("hidden"),renderRunnerView(),r.classList.remove("tab-inactive"),r.classList.add("bg-primary","text-white"),a.classList.remove("bg-primary","text-white"),a.classList.add("tab-inactive")):"pace"===e&&(t.classList.add("hidden"),n.classList.remove("hidden"),renderPaceView(),a.classList.remove("tab-inactive"),a.classList.add("bg-primary","text-white"),r.classList.remove("bg-primary","text-white"),r.classList.add("tab-inactive"))}function getRunnerElements(e){let t=document.getElementById(`runner-row-${e}`);return t?{nameInput:t.querySelector(".runner-name"),paceContainer:t.querySelector(".pace-container")}:null}function applyValidationHighlight(e,t){let n=runners[e],r=getRunnerElements(e);if(!r||!n)return;let{nameInput:a,paceContainer:s}=r;if(a.classList.remove("validation-border"),s.classList.remove("validation-border"),n.active){if(t.has(e)||!n.name.trim()){a.classList.add("validation-border");return}0===n.paces.length&&s.classList.add("validation-border")}}function generatePaceCheckboxes(e,t){return PACE_GROUPS.map(n=>`
                <input type="checkbox" id="pace-${e}-${n.replace(/[:\/ ]/g,"-")}" 
                       data-pace="${n}" class="pace-checkbox hidden" value="${n}" data-runner-id="${e}"
                       ${t.includes(n)?"checked":""}>
                <label for="pace-${e}-${n.replace(/[:\/ ]/g,"-")}" 
                       class="inline-block px-2 py-1 text-xs font-medium text-gray-700 bg-gray-100 border border-gray-300 rounded-full cursor-pointer hover:bg-gray-200 transition duration-150 ease-in-out m-0.5 whitespace-nowrap">
                    ${n.split(" ")[0]}
                </label>
            `).join("")}function renderRunnerRow(e,t){let n=document.createElement("tr");return n.id=`runner-row-${e.id}`,n.className="runner-row",n.innerHTML=`
                <!-- Index -->
                <td class="px-3 py-3 whitespace-nowrap"><span class="text-sm text-gray-500">${t+1}</span></td>
                
                <!-- Name Input -->
                <td class="px-6 py-3 whitespace-nowrap">
                    <input type="text" placeholder="e.g., Jane Doe" required value="${e.name}" data-runner-id="${e.id}"
                           class="runner-name w-full p-2 border border-gray-300 rounded-lg text-sm focus:ring-primary focus:border-primary">
                </td>

                <!-- Seniority Input -->
                <td class="px-6 py-3 whitespace-nowrap">
                    <input type="number" value="${e.seniority}" min="1" required data-runner-id="${e.id}"
                           class="runner-seniority w-20 p-2 border border-gray-300 rounded-lg text-sm text-center focus:ring-primary focus:border-primary">
                </td>

                <!-- Pace Checkboxes -->
                <td class="px-6 py-3 whitespace-nowrap">
                    <div id="pace-container-${e.id}" class="pace-container flex flex-wrap space-x-1 p-1 border border-transparent rounded-lg transition duration-150 ease-in-out">
                        ${generatePaceCheckboxes(e.id,e.paces)}
                    </div>
                </td>
                
                <!-- Active Toggle -->
                <td class="px-3 py-3 whitespace-nowrap">
                    <div class="flex justify-center items-center h-full">
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" ${e.active?"checked":""} class="sr-only peer runner-active-toggle" data-runner-id="${e.id}">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary/40 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                            <span class="ml-3 text-sm font-medium text-gray-900 sr-only">Active Toggle</span>
                        </label>
                    </div>
                </td>

                <!-- Delete Button -->
                <td class="px-3 py-3 whitespace-nowrap">
                    <button onclick="deleteRunner('${e.id}')" class="p-2 text-red-500 hover:text-red-700 rounded-full transition duration-150">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </td>
            `,n}function renderRunnerView(){let e=document.getElementById("runners-list");e.innerHTML="";let t=Object.values(runners).sort((e,t)=>e.seniority-t.seniority),n=findDuplicateNames();t.forEach((t,r)=>{let a=renderRunnerRow(t,r);e.appendChild(a),applyValidationHighlight(t.id,n)}),setupRunnerViewListeners()}function setupRunnerViewListeners(){let e=document.getElementById("runners-list");e.removeEventListener("change",handleRunnerInput),e.removeEventListener("input",handleRunnerInput),e.addEventListener("change",handleRunnerInput),e.addEventListener("input",handleRunnerInput)}function handleRunnerInput(e){let t=e.target,n=t.dataset.runnerId;if(!runners[n])return;if(t.classList.contains("runner-name"))updateRunnerData(n,"name",t.value.trim());else if(t.classList.contains("runner-seniority"))updateRunnerData(n,"seniority",parseInt(t.value));else if(t.classList.contains("runner-active-toggle"))updateRunnerData(n,"active",t.checked);else if(t.classList.contains("pace-checkbox")){let r=runners[n],a=r.paces,s=t.getAttribute("data-pace");if(t.checked)a.includes(s)||a.push(s);else{let i=a.indexOf(s);i>-1&&a.splice(i,1)}r.paces=a}let l=findDuplicateNames();t.classList.contains("runner-name")||t.classList.contains("runner-active-toggle")?Object.keys(runners).forEach(e=>{applyValidationHighlight(e,l)}):applyValidationHighlight(n,l),markInputChanged()}function collectRunnerDataFromUI(){if("pace"===currentView)return;let e=document.querySelectorAll(".runner-row"),t=findDuplicateNames();e.forEach(e=>{let n=e.id.replace("runner-row-","");if(!runners[n])return;let r=e.querySelector(".runner-name"),a=e.querySelector(".runner-seniority"),s=e.querySelector(".runner-active-toggle"),i=e.querySelectorAll(".pace-checkbox"),l=Array.from(i).filter(e=>e.checked).map(e=>e.getAttribute("data-pace"));runners[n].name=r.value.trim(),runners[n].seniority=parseInt(a.value)||1,runners[n].paces=l,runners[n].active=s.checked,applyValidationHighlight(n,t)})}function exportRunners(){collectRunnerDataFromUI();let e=Object.values(runners).filter(e=>e.name).map(e=>({name:e.name,seniority:e.seniority,paces:e.paces,active:e.active})),t=JSON.stringify(e,null,2);navigator.clipboard?navigator.clipboard.writeText(t).then(()=>{statusEl.textContent="Status: Runner data copied to clipboard as JSON!",statusEl.className="success font-bold text-lg mb-4"}).catch(e=>{console.error("Failed to copy text: ",e),prompt("Copy the following JSON data manually:",t),statusEl.textContent="Status: Clipboard copy failed. Data ready in prompt box for manual copy.",statusEl.className="font-bold text-lg mb-4 text-secondary"}):(prompt("Copy the following JSON data manually:",t),statusEl.textContent="Status: Runner data ready in prompt box for manual copy.",statusEl.className="font-bold text-lg mb-4 text-secondary")}function importRunners(){let e=prompt("Paste the JSON string containing runner data here:");if(!e){statusEl.textContent="Status: Import cancelled.",statusEl.className="font-bold text-lg mb-4 text-gray-800";return}try{let t=JSON.parse(e);if(!Array.isArray(t)||t.some(e=>"object"!=typeof e||void 0===e.name||void 0===e.seniority))throw Error("Invalid JSON structure. Expected an array of runner objects with 'name' and 'seniority' fields.");clearAllRunners(!0),t.forEach(e=>{createNewRunnerInData(e.name,e.seniority,e.paces||[],void 0===e.active||e.active)}),"runner"===currentView?renderRunnerView():renderPaceView(),markInputChanged(),window.scrollTo({top:0,behavior:"smooth"}),statusEl.textContent=`Status: Successfully imported ${t.length} runners. Run the solver to get assignments.`,statusEl.className="success font-bold text-lg mb-4"}catch(n){console.error("Import Error:",n),statusEl.textContent=`Error: Failed to import data. ${n.message||"Invalid JSON format."}`,statusEl.className="error font-bold text-lg mb-4"}}function generatePaceGroups(){let e={};for(let t=14;t<=22;t++){let n=t/2,r=Math.floor(n),a=Math.round((n-r)*60),s=`${r}:${a.toString().padStart(2,"0")} min/mile`;e[s]=n}return e}function solveAssignmentProblem(e){let t=generatePaceGroups(),n=Object.keys(t),r={...t},a=Math.max(...Object.values(r)),s=Object.keys(e);if(0===s.length)return{error:"No active runners provided for assignment."};let i={},l={};s.forEach(t=>{i[t]=e[t].paces,l[t]=e[t].seniority});let o=s.sort((e,t)=>{let n=l[e]-l[t];return 0!==n?n:e.localeCompare(t)}),u=Math.max(...Object.values(l)),c=Object.fromEntries(o.map(e=>[e,u+1-l[e]])),d=Object.fromEntries(n.map(e=>[e,a-r[e]])),p={};for(let m of o)for(let f of n){let g=i[m].includes(f);p[`${m}|${f}`]=g?c[m]*d[f]*1e-6:0}let $={};for(let h of o)for(let b of n)$[`${h}|${b}`]=i[h].includes(b)?1:0;let v={optimize:"range",opType:"min",constraints:{},variables:{},ints:{}};v.variables.Z_max={range:1},v.variables.Z_min={range:-1},n.forEach(e=>{let t=`N_${e}`;v.variables[t]={[`count_link_${e}`]:1,[`max_bound_${e}`]:-1,[`min_bound_${e}`]:-1},v.ints[t]=1,v.constraints[`count_link_${e}`]={equal:0},v.constraints[`max_bound_${e}`]={min:0},v.variables.Z_max[`max_bound_${e}`]=1,v.constraints[`min_bound_${e}`]={max:0},v.variables.Z_min[`min_bound_${e}`]=1}),o.forEach(e=>{let t=`runner_assign_${e}`;v.constraints[t]={equal:1},n.forEach(n=>{let r=`assign_${e}_${n}`;v.variables[r]={[t]:1,[`count_link_${n}`]:-1},v.ints[r]=1;let a=`ability_${e}_${n}`;v.constraints[a]={min:0,max:$[`${e}|${n}`]},v.variables[r][a]=1})});let y=solver.Solve(v);if(!y.feasible)return{error:"No feasible solution found. Cannot assign all runners based on preferences."};let x=y.result,w={optimize:"totalCost",opType:"min",constraints:{},variables:{},ints:{}};w.variables.Z_max_2={fixed_range:1},w.variables.Z_min_2={fixed_range:-1},n.forEach(e=>{let t=`N2_${e}`;w.variables[t]={[`count_link_2_${e}`]:1,[`max_bound_2_${e}`]:-1,[`min_bound_2_${e}`]:-1},w.ints[t]=1,w.constraints[`count_link_2_${e}`]={equal:0},w.constraints[`max_bound_2_${e}`]={min:0},w.variables.Z_max_2[`max_bound_2_${e}`]=1,w.constraints[`min_bound_2_${e}`]={max:0},w.variables.Z_min_2[`min_bound_2_${e}`]=1}),o.forEach(e=>{let t=`runner_assign_2_${e}`;w.constraints[t]={equal:1},n.forEach(n=>{let a=`assign_${e}_${n}`,s=r[n]-p[`${e}|${n}`];w.variables[a]={totalCost:s,[t]:1,[`count_link_2_${n}`]:-1},w.ints[a]=1;let i=`ability_2_${e}_${n}`;w.constraints[i]={min:0,max:$[`${e}|${n}`]},w.variables[a][i]=1})}),w.constraints.fixed_range={equal:x};let E=solver.Solve(w);if(!E.feasible)return{error:"Failed to find a pace-optimal solution that maintains the minimum group balance. Try reducing constraints."};let _={assignments:{},groups:{}};for(let I in n.forEach(e=>_.groups[e]=[]),e){for(let R of n)1===E[`assign_${I}_${R}`]&&(_.assignments[I]=R,_.groups[R].push(I));delete e[I].paces}return _.meta={minRange:x,totalCost:E.result},_}function runSolver(){if(collectRunnerDataFromUI(),!inputChanged&&hasEverSolved){statusEl.textContent="Status: Input has not changed since last successful solve.",statusEl.className="font-bold text-lg mb-4 text-gray-800";return}resultsEl.innerHTML="",statusEl.textContent="Status: Validating runner data...",statusEl.className="font-bold text-lg mb-4 text-gray-800";let e={},t=!1,n=!1,r=findDuplicateNames(),a=r.size>0;if(Object.values(runners).forEach(a=>{if(applyValidationHighlight(a.id,r),!a.active)return;let s=a.name;s.trim()||(t=!0),s.trim()&&0===a.paces.length&&(n=!0),s.trim()&&a.paces.length>0&&!r.has(a.id)&&(e[a.id]=a)}),t||a||n){let s=[];t&&s.push("One or more active runners are missing a **Name**."),a&&s.push("One or more active runners have **Duplicate Names**."),n&&s.push("One or more active runners have **No Pace Preferences** selected."),statusEl.textContent=`Error: Data validation failed. ${s.join(" ")}`,statusEl.className="error font-bold text-lg mb-4","pace"===currentView&&switchView("runner"),setSolverButtonState(!0);return}if(0===Object.keys(e).length){statusEl.textContent="Status: No active or valid runner data provided.",statusEl.className="font-bold text-lg mb-4 text-gray-800",setSolverButtonState(!1);return}let i=solveAssignmentProblem(e);i.error?(statusEl.textContent=`Error: ${i.error}`,statusEl.className="error font-bold text-lg mb-4",resultsEl.innerHTML='<p class="text-red-600 p-3 bg-red-50 rounded-lg">Optimization failed. Check if all active runners have at least one pace preference selected and if the preferences allow for a balanced solution.</p>',setSolverButtonState(!0)):(statusEl.textContent="Status: Done!",statusEl.className="success font-bold text-lg mb-4",displayResults(i,e),inputChanged=!1,hasEverSolved=!0,setSolverButtonState(!1))}function displayResults(e,t){resultsEl.innerHTML=`
                <h3 class="font-semibold text-lg text-gray-800 pb-2">Assignments by Pace Group</h3>
                <div id="groups-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Group cards go here -->
                </div>
            `;let n=document.getElementById("groups-list"),r=Object.keys(e.groups).sort((e,t)=>{let n=e=>{let[t,n]=e.split(" ")[0].split(":").map(Number);return t+n/60};return n(e)-n(t)});r.forEach(r=>{let a=e.groups[r];if(a.length>0){let s=a.sort((e,n)=>t[e].seniority-t[n].seniority),i=s.map(e=>{let n=t[e];return`<span class="inline-block bg-primary/20 text-primary px-2 py-0.5 text-xs font-medium rounded-full m-0.5">${n.name} (${n.seniority})</span>`}).join("");n.innerHTML+=`
                        <div class="p-4 bg-white shadow rounded-lg border-l-4 border-primary">
                            <p class="font-bold text-md mb-2">${r} <span class="text-gray-500 font-normal">(${a.length} runners)</span></p>
                            <div class="flex flex-wrap">${i}</div>
                        </div>
                    `}})}window.onload=()=>{createNewRunnerInData("",1,[],!0),switchView("runner"),statusEl.textContent="Status: Ready to configure runners and solve.",statusEl.className="font-bold text-lg mb-4 text-gray-800"};
    </script>
</body>
</html>
